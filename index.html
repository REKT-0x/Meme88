<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>$LE Meme Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --neon: #00ff88; --hotpink: #ff00ff; --cyan: #00ffff; }
        
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; background-color: #050505;
            background-image: linear-gradient(rgba(0, 255, 136, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 136, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            color: white; font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; 
            height: 100vh; height: -webkit-fill-available; /* Fix for mobile browser bars */
        }

        /* Top Header */
        header { padding: 10px; text-align: center; border-bottom: 1px solid var(--neon); background: rgba(0,0,0,0.8); }
        h1 { font-style: italic; color: var(--neon); text-shadow: 2px 2px var(--hotpink); font-size: 1.2rem; margin: 0; }

        /* Middle Section - The Meme */
        #workspace { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            padding: 10px; overflow: hidden; position: relative;
        }
        .canvas-container { border: 2px solid var(--hotpink); box-shadow: 0 0 20px rgba(255, 0, 255, 0.2); }

        /* Bottom Section - The Controls */
        #controls { 
            background: rgba(10, 10, 10, 0.98); border-top: 2px solid var(--neon);
            padding: 12px; max-height: 50vh; overflow-y: auto;
        }

        @media (min-width: 768px) {
            body { flex-direction: row; }
            header { display: none; }
            #controls { width: 380px; height: 100vh; border-top: none; border-right: 2px solid var(--neon); max-height: none; }
        }

        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 6px; border: 1px solid var(--cyan); background: #000; color: white; outline: none; font-size: 16px; } /* 16px prevents iOS zoom */
        
        .btn-add { background: var(--neon); color: #000; font-weight: bold; border: none; padding: 0 15px; border-radius: 6px; }

        .quick-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 12px; }
        .btn-q { background: #151515; color: var(--cyan); border: 1px solid var(--cyan); padding: 8px 2px; font-size: 10px; border-radius: 4px; cursor: pointer; }

        .palette { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .swatch { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-main { padding: 12px; border: none; font-weight: bold; border-radius: 6px; text-transform: uppercase; font-size: 11px; cursor: pointer; }
        .btn-x { background: #000; color: white; border: 1px solid white; grid-column: span 2; }
        .btn-save { background: var(--hotpink); color: white; }
        .btn-gal { background: #333; color: white; }

        .scroll-templates { display: flex; overflow-x: auto; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; }
        .thumb { height: 60px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <header><h1>$LE MEME STUDIO</h1></header>

    <div id="workspace">
        <canvas id="memeCanvas"></canvas>
    </div>

    <div id="controls">
        <div class="palette">
            <div class="swatch" style="background: #ffffff;" onclick="setColor('#ffffff')"></div>
            <div class="swatch" style="background: #00ff88;" onclick="setColor('#00ff88')"></div>
            <div class="swatch" style="background: #ff00ff;" onclick="setColor('#ff00ff')"></div>
            <div class="swatch" style="background: #00ffff;" onclick="setColor('#00ffff')"></div>
            <div class="swatch" style="background: #ffff00;" onclick="setColor('#ffff00')"></div>
            <div class="swatch" style="background: #ff3e3e;" onclick="setColor('#ff3e3e')"></div>
        </div>

        <div class="input-row">
            <input type="text" id="textInput" placeholder="TYPE HERE...">
            <button class="btn-add" onclick="addCustomText()">ADD</button>
        </div>

        <div class="quick-grid">
            <button class="btn-q" onclick="addCustomText('PUMP IT')">PUMP IT</button>
            <button class="btn-q" onclick="addCustomText('WAGMI')">WAGMI</button>
            <button class="btn-q" onclick="addCustomText('LFG')">LFG</button>
            <button class="btn-q" onclick="addCustomText('HODL')">HODL</button>
            <button class="btn-q" onclick="addCustomText('BULLISH')">BULLISH</button>
            <button class="btn-q" onclick="addCustomText('MOON')">MOON</button>
        </div>

        <div class="action-grid">
            <button class="btn-main btn-x" onclick="shareToX()">SHARE TO X</button>
            <button class="btn-main btn-save" onclick="downloadMeme()">SAVE PNG</button>
            <button class="btn-main btn-gal" onclick="document.getElementById('fileInput').click()">GALLERY</button>
        </div>

        <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileUpload(event)">
        <div class="scroll-templates" id="template-list"></div>
        <p style="font-size: 8px; text-align: center; color: #555; margin-top: 10px;">Double tap text to delete</p>
    </div>

    <script>
        const canvas = new fabric.Canvas('memeCanvas');
        const DEFAULT_IMG = 'IMG_3663.jpeg'; 
        const APE_LINK = "https://ape.express/explore/0x1f7ef975e14d3d9d8d0592e5040635026f4851e0";
        let currentColor = '#ffffff';

        window.onload = () => { loadMeme(DEFAULT_IMG); fetchTemplates(); };

        function setColor(color) {
            currentColor = color;
            const active = canvas.getActiveObject();
            if (active && active.type === 'i-text') {
                active.set({ fill: color, shadow: new fabric.Shadow({ color: color, blur: 15 }) });
                canvas.renderAll();
            }
        }

        function loadMeme(url) {
            fabric.Image.fromURL(url, function(img) {
                // Determine available space for the canvas
                const workspace = document.getElementById('workspace');
                const padding = 20;
                const maxWidth = workspace.clientWidth - padding;
                const maxHeight = workspace.clientHeight - padding;
                
                const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
                
                canvas.setDimensions({ width: img.width * ratio, height: img.height * ratio });
                img.scale(ratio);
                img.set({ selectable: false, evented: false });
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                
                canvas.getObjects('i-text').forEach(obj => canvas.remove(obj));
                addWatermark();
            }, { crossOrigin: 'anonymous' });
        }

        function handleFileUpload(e) {
            const reader = new FileReader();
            reader.onload = (f) => loadMeme(f.target.result);
            reader.readAsDataURL(e.target.files[0]);
        }

        function addWatermark() {
            const wm = new fabric.Text('$LE', {
                left: canvas.width - 10, top: 10, originX: 'right', fontFamily: 'Impact', fontSize: canvas.width / 20,
                fill: '#00ff88', stroke: 'black', strokeWidth: 1, selectable: false, evented: false,
                shadow: new fabric.Shadow({ color: '#00ff88', blur: 8 })
            });
            canvas.add(wm);
        }

        function addCustomText(over) {
            const val = over || document.getElementById('textInput').value || "TEXT";
            const text = new fabric.IText(val, {
                left: canvas.width / 2, top: canvas.height / 2, originX: 'center',
                fontFamily: 'Impact', fontSize: canvas.width / 10, fill: currentColor, stroke: 'black',
                strokeWidth: 2, fontWeight: 'bold', textAlign: 'center',
                shadow: new fabric.Shadow({ color: currentColor, blur: 15 })
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            if(!over) document.getElementById('textInput').value = '';
        }

        function downloadMeme() {
            const link = document.createElement('a');
            link.download = 'LE-MEME.png';
            link.href = canvas.toDataURL({ format: 'png' });
            link.click();
        }

        function shareToX() {
            const text = encodeURIComponent(`ðŸ’ŽðŸ’Ž $LE ðŸ’ŽðŸ’Ž\n\nDYOR and Nfa\n\n${APE_LINK}`);
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        function fetchTemplates() {
            fetch('https://api.imgflip.com/get_memes').then(r => r.json()).then(d => {
                const list = document.getElementById('template-list');
                d.data.memes.slice(0, 15).forEach(m => {
                    const i = document.createElement('img');
                    i.src = m.url; i.className = 'thumb';
                    i.onclick = () => loadMeme(m.url);
                    list.appendChild(i);
                });
            });
        }

        canvas.on('mouse:dblclick', (o) => { if(o.target && o.target.type === 'i-text') canvas.remove(o.target); });
    </script>
</body>
</html>
